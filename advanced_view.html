<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Salary Analytics</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --border: #334155;
      --hover: #334155;
      --btn-active: #0ea5e9;
      --btn-text: #e2e8f0;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      padding-bottom: 40px;
    }

    header {
      padding: 15px 30px;
      border-bottom: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--accent); }
    
    .nav-back {
      text-decoration: none;
      color: var(--text-muted);
      font-size: 14px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-back:hover {
      background: var(--hover);
      color: var(--text-main);
    }

    /* Filter Section */
    .filter-panel {
      padding: 15px 30px;
      background: #162032;
      border-bottom: 1px solid var(--border);
    }
    .filter-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 8px;
    }
    .filter-row:last-child { margin-bottom: 0; }
    .filter-label {
      min-width: 80px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      flex: 1;
    }
    button.filter-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    button.filter-btn:hover {
      background: var(--hover);
      color: var(--text-main);
    }
    button.filter-btn.active {
      background: var(--btn-active);
      color: white;
      border-color: var(--btn-active);
    }
    button.clear-btn {
        margin-left: auto;
        background: #ef4444;
        color: white;
        border: none;
        padding: 5px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 11px;
    }

    /* Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr); 
      gap: 15px;
      padding: 20px;
    }
    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    .chart-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      height: 340px; /* Slightly taller to accommodate margins */
      display: flex;
      flex-direction: column;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
    }
    .chart-meta {
      font-size: 11px;
      color: var(--text-muted);
    }
    .viz-container {
      flex: 1;
      position: relative;
      width: 100%;
      overflow: hidden;
    }
    
    #tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-main);
      pointer-events: none;
      opacity: 0;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }

    .axis text { fill: var(--text-muted); font-size: 10px; }
    .axis path, .axis line { stroke: var(--border); }
    .bar { fill: var(--accent); opacity: 0.8; transition: opacity 0.2s; }
    .bar:hover { opacity: 1; }
    .error-msg { color: #f43f5e; font-size: 12px; padding: 20px; }
  </style>
</head>
<body>

<header>
  <h1>Advanced Salary Analytics</h1>
  <div style="display:flex; gap:15px; align-items:center;">
    <div id="stats" style="font-size:12px; color:var(--text-muted);">Loading data...</div>
    <a href="index.html" class="nav-back">Back to Main</a>
  </div>
</header>

<div class="filter-panel">
  <div class="filter-row">
    <div class="filter-label">Role</div>
    <div class="filter-buttons" id="roleFilters"></div>
  </div>
  <div class="filter-row">
    <div class="filter-label">Industry</div>
    <div class="filter-buttons" id="industryFilters"></div>
  </div>
  <div class="filter-row">
    <div class="filter-label">Country</div>
    <div class="filter-buttons" id="countryFilters"></div>
    <button class="clear-btn" onclick="resetFilters()">Reset</button>
  </div>
</div>

<div class="dashboard-grid">
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">1. Average Salary by Language</div>
      <div class="chart-meta">Top 12 (Count >= 10)</div>
    </div>
    <div id="chart1" class="viz-container"></div>
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">2. Skill Salary Index (Normalized)</div>
      <div class="chart-meta">Metric: SS Index</div>
    </div>
    <div id="chart2" class="viz-container"></div>
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">3. Polyglot Premium</div>
      <div class="chart-meta">Count of Languages vs. Salary</div>
    </div>
    <div id="chart3" class="viz-container"></div>
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">4. The Database Effect</div>
      <div class="chart-meta">Language Only vs. Lang + Database</div>
    </div>
    <div id="chart4" class="viz-container"></div>
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">5. Organization Size & Salary</div>
      <div class="chart-meta">Sorted by Size (Employees)</div>
    </div>
    <div id="chart5" class="viz-container"></div>
  </div>

  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">6. AI Adoption Premium</div>
      <div class="chart-meta">LearnCodeAI: Yes vs No</div>
    </div>
    <div id="chart6" class="viz-container"></div>
  </div>
</div>

<div id="tooltip"></div>

<script>
let rawData = [];
let filteredData = [];

const activeFilters = {
  roles: new Set(),
  industries: new Set(),
  countries: new Set()
};

const ROLE_DEFINITIONS = {
  'Frontend': ['front-end'],
  'Backend': ['back-end'],
  'FullStack': ['full-stack'],
  'Data/AI': ['data', 'ai', 'scientist', 'analyst'],
  'Mobile': ['mobile'],
  'DevOps/Cloud': ['devops', 'cloud', 'infrastructure'],
  'Manager': ['manager']
};

const ORG_ORDER = [
  'Just me - I am a freelancer, sole proprietor, etc.',
  '2 to 9 employees',
  '10 to 19 employees',
  '20 to 99 employees',
  '100 to 499 employees',
  '500 to 999 employees',
  '1,000 to 4,999 employees',
  '5,000 to 9,999 employees',
  '10,000 or more employees',
  'I donâ€™t know'
];

const LANG_NORMALIZE = {
  'Bash/Shell (all shells)': 'Bash/Shell'
};

const DURATION = 750;

d3.csv('dataset_new.csv', d3.autoType).then(data => {
  rawData = data.filter(d => d.Salary && d.Salary > 0);
  
  rawData.forEach(d => {
    const ai = (d.LearnCodeAI || '').toLowerCase();
    if (ai.startsWith('yes')) d.AI_Simple = 'Yes';
    else if (ai.startsWith('no')) d.AI_Simple = 'No';
    else d.AI_Simple = 'Unknown';
    
    if (!d.OrgSize) d.OrgSize = 'Unknown';

    if (d.Industry === 'Other:') {
        d.Industry = 'Others';
    }
  });

  initFilters();
  updateDashboard();
}).catch(err => {
  console.error("Error loading CSV:", err);
  document.getElementById('stats').innerText = "Error loading dataset_new.csv";
});

function initFilters() {
  renderButtons('roleFilters', Object.keys(ROLE_DEFINITIONS), 'roles');

  const industryCounts = d3.rollups(rawData, v => v.length, d => d.Industry).sort((a,b) => b[1] - a[1]);
  let topInd = industryCounts.map(d => d[0]).filter(d => d && d !== 'Others');
  topInd = topInd.slice(0, 14);
  const hasOthers = rawData.some(d => d.Industry === 'Others');
  if (hasOthers) topInd.push('Others');
  renderButtons('industryFilters', topInd, 'industries');

  const countryCounts = d3.rollups(rawData, v => v.length, d => d.Country).sort((a,b) => b[1] - a[1]);
  const topCountries = countryCounts.slice(0, 12).map(d => d[0]).filter(d => d);
  renderButtons('countryFilters', topCountries, 'countries');
}

function renderButtons(containerId, items, filterType) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  items.forEach(item => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.innerText = item;
    btn.onclick = () => toggleFilter(btn, filterType, item);
    container.appendChild(btn);
  });
}

function toggleFilter(btn, type, value) {
  if (activeFilters[type].has(value)) {
    activeFilters[type].delete(value);
    btn.classList.remove('active');
  } else {
    activeFilters[type].add(value);
    btn.classList.add('active');
  }
  updateDashboard();
}

function resetFilters() {
  activeFilters.roles.clear();
  activeFilters.industries.clear();
  activeFilters.countries.clear();
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  updateDashboard();
}

function updateDashboard() {
  filteredData = rawData.filter(d => {
    if (activeFilters.roles.size > 0) {
      const devType = (d.DevType || '').toLowerCase();
      const matches = Array.from(activeFilters.roles).some(roleKey => {
        return ROLE_DEFINITIONS[roleKey].some(sub => devType.includes(sub));
      });
      if (!matches) return false;
    }
    if (activeFilters.industries.size > 0) {
      if (!activeFilters.industries.has(d.Industry)) return false;
    }
    if (activeFilters.countries.size > 0) {
      if (!activeFilters.countries.has(d.Country)) return false;
    }
    return true;
  });

  document.getElementById('stats').innerText = `${filteredData.length} records`;

  if (filteredData.length === 0) {
    [1,2,3,4,5,6].forEach(i => {
        const c = document.getElementById(`chart${i}`);
        // keep height but clear content
        c.querySelector('svg')?.remove();
        c.innerHTML = '<p class="error-msg">No data matches</p>';
    });
    return;
  }

  tryRender(renderChart1, 'chart1');
  tryRender(renderChart2, 'chart2');
  tryRender(renderChart3, 'chart3');
  tryRender(renderChart4, 'chart4');
  tryRender(renderChart5, 'chart5');
  tryRender(renderChart6, 'chart6');
}

function tryRender(renderFn, elementId) {
  try {
    // Clear error message if present
    const container = document.getElementById(elementId);
    if (container.querySelector('.error-msg')) {
        container.innerHTML = '';
    }
    renderFn();
  } catch (e) {
    console.error(`Error rendering ${elementId}:`, e);
  }
}

// ==========================================
// CHART 1: Avg Salary
// ==========================================
function renderChart1() {
  const container = document.getElementById('chart1');
  const { innerH, innerW, x, y, g, xAxisG, yAxisG } = setupChart(container, { left: 90, bottom: 25 }); // More margin

  const langStats = new Map();
  filteredData.forEach(d => {
    if (!d.Language) return;
    const langs = d.Language.split(';').map(s => s.trim());
    langs.forEach(l => {
      const name = LANG_NORMALIZE[l] || l;
      if (!langStats.has(name)) langStats.set(name, { sum: 0, count: 0 });
      const entry = langStats.get(name);
      entry.sum += +d.Salary;
      entry.count += 1;
    });
  });

  const data = Array.from(langStats.entries())
    .map(([lang, val]) => ({ lang, avg: val.sum / val.count, count: val.count }))
    .filter(d => d.count >= 10)
    .sort((a,b) => b.avg - a.avg)
    .slice(0, 12);

  y.domain(data.map(d => d.lang));
  x.domain([0, d3.max(data, d => d.avg) || 100000]);

  yAxisG.transition().duration(DURATION).call(d3.axisLeft(y));
  xAxisG.transition().duration(DURATION).call(d3.axisBottom(x).ticks(4).tickFormat(d => `$${d/1000}k`));

  g.selectAll(".bar")
    .data(data, d => d.lang)
    .join(
      enter => enter.append("rect").attr("class", "bar")
        .attr("y", d => y(d.lang))
        .attr("height", y.bandwidth())
        .attr("x", 0).attr("width", 0)
        .call(enter => enter.transition().duration(DURATION).attr("width", d => x(d.avg))),
      update => update.call(update => update.transition().duration(DURATION)
        .attr("y", d => y(d.lang))
        .attr("height", y.bandwidth())
        .attr("width", d => x(d.avg))),
      exit => exit.call(exit => exit.transition().duration(DURATION).attr("width", 0).remove())
    )
    .on("mouseover", (e, d) => showTooltip(e, `<b>${d.lang}</b><br>Avg: $${Math.round(d.avg).toLocaleString()}<br>Count: ${d.count}`))
    .on("mouseout", hideTooltip);
}

// ==========================================
// CHART 2: SS Index
// ==========================================
function renderChart2() {
  const container = document.getElementById('chart2');
  const { innerH, innerW, x, y, g, xAxisG, yAxisG } = setupChart(container, { left: 90, bottom: 25 });

  const langStats = new Map();
  filteredData.forEach(d => {
    if (!d.Language || !d['SS Index']) return;
    const langs = d.Language.split(';').map(s => s.trim());
    langs.forEach(l => {
      const name = LANG_NORMALIZE[l] || l;
      if (!langStats.has(name)) langStats.set(name, { sum: 0, count: 0 });
      const entry = langStats.get(name);
      entry.sum += +d['SS Index'];
      entry.count += 1;
    });
  });

  const data = Array.from(langStats.entries())
    .map(([lang, val]) => ({ lang, avg: val.sum / val.count, count: val.count }))
    .filter(d => d.count >= 10)
    .sort((a,b) => b.avg - a.avg)
    .slice(0, 12);

  y.domain(data.map(d => d.lang));
  x.domain([0, d3.max(data, d => d.avg) || 100000]);

  yAxisG.transition().duration(DURATION).call(d3.axisLeft(y));
  xAxisG.transition().duration(DURATION).call(d3.axisBottom(x).ticks(4));

  g.selectAll(".stick").data(data, d => d.lang).join(
      enter => enter.append("line").attr("class", "stick")
        .attr("stroke", "#334155").attr("stroke-width", 2)
        .attr("x1", 0).attr("x2", 0)
        .attr("y1", d => y(d.lang) + y.bandwidth()/2).attr("y2", d => y(d.lang) + y.bandwidth()/2)
        .call(enter => enter.transition().duration(DURATION).attr("x2", d => x(d.avg))),
      update => update.call(update => update.transition().duration(DURATION)
        .attr("y1", d => y(d.lang) + y.bandwidth()/2).attr("y2", d => y(d.lang) + y.bandwidth()/2)
        .attr("x2", d => x(d.avg))),
      exit => exit.call(exit => exit.transition().duration(DURATION).attr("x2", 0).remove())
    );

  g.selectAll(".head").data(data, d => d.lang).join(
      enter => enter.append("circle").attr("class", "head")
        .attr("r", 5).attr("fill", "#f43f5e").attr("cx", 0).attr("cy", d => y(d.lang) + y.bandwidth()/2)
        .call(enter => enter.transition().duration(DURATION).attr("cx", d => x(d.avg))),
      update => update.call(update => update.transition().duration(DURATION)
        .attr("cy", d => y(d.lang) + y.bandwidth()/2).attr("cx", d => x(d.avg))),
      exit => exit.call(exit => exit.transition().duration(DURATION).attr("cx", 0).remove())
    )
    .on("mouseover", (e, d) => showTooltip(e, `<b>${d.lang}</b><br>SS Index: ${Math.round(d.avg).toLocaleString()}`))
    .on("mouseout", hideTooltip);
}

// ==========================================
// CHART 3: Multi-language (FIXED PADDING)
// ==========================================
function renderChart3() {
  const container = document.getElementById('chart3');
  const { innerH, innerW, x, y, g, xAxisG, yAxisG } = setupChart(container, { left: 60, bottom: 40 }, 'linear', 'vertical');

  const countStats = new Map();
  filteredData.forEach(d => {
    if (!d.Language) return;
    const count = d.Language.split(';').length;
    const key = count > 10 ? 10 : count;
    if (!countStats.has(key)) countStats.set(key, { sum: 0, count: 0 });
    const entry = countStats.get(key);
    entry.sum += +d.Salary;
    entry.count += 1;
  });

  const data = Array.from(countStats.entries())
    .map(([k, v]) => ({ num: k, avg: v.sum / v.count, count: v.count }))
    .sort((a,b) => a.num - b.num);

  if (data.length === 0) {
    g.selectAll("*").remove(); return;
  }

  const minSal = d3.min(data, d => d.avg) || 0;
  const maxSal = d3.max(data, d => d.avg) || 100000;
  
  // PADDING FIX: Start 10% lower than min to avoid bottom clipping
  const yMin = Math.max(0, minSal * 0.9);
  const yMax = maxSal * 1.05;

  x.domain([1, 10]);
  y.domain([yMin, yMax]).nice();

  yAxisG.transition().duration(DURATION).call(d3.axisLeft(y).ticks(5).tickFormat(d => `$${Math.round(d/1000)}k`));
  xAxisG.transition().duration(DURATION).call(d3.axisBottom(x));
  
  // Label check
  if (g.select(".x-label").empty()) {
    g.append("text").attr("class", "x-label")
      .attr("x", innerW/2).attr("y", innerH + 30) // Push label down
      .attr("fill", "var(--text-muted)")
      .attr("text-anchor", "middle").style("font-size", "10px")
      .text("Number of Languages Known");
  }

  const line = d3.line().x(d => x(d.num)).y(d => y(d.avg)).curve(d3.curveMonotoneX);

  const path = g.selectAll(".line-path").data([data]);
  path.join(
    enter => enter.append("path").attr("class", "line-path")
      .attr("fill", "none").attr("stroke", "#10b981").attr("stroke-width", 3).attr("d", line)
      .style("opacity", 0).call(enter => enter.transition().duration(DURATION).style("opacity", 1)),
    update => update.call(update => update.transition().duration(DURATION).attr("d", line)),
    exit => exit.remove()
  );

  g.selectAll(".dot").data(data, d => d.num).join(
      enter => enter.append("circle").attr("class", "dot")
        .attr("r", 0).attr("fill", "#10b981").attr("stroke", "#fff")
        .attr("cx", d => x(d.num)).attr("cy", d => y(d.avg))
        .call(enter => enter.transition().duration(DURATION).attr("r", 4)),
      update => update.call(update => update.transition().duration(DURATION)
        .attr("cx", d => x(d.num)).attr("cy", d => y(d.avg))),
      exit => exit.call(exit => exit.transition().duration(DURATION).attr("r", 0).remove())
    )
    .on("mouseover", (e, d) => showTooltip(e, `<b>${d.num} Languages</b><br>Avg: $${Math.round(d.avg).toLocaleString()}`))
    .on("mouseout", hideTooltip);
}

// ==========================================
// CHART 4: Lang vs DB (FIXED PADDING)
// ==========================================
function renderChart4() {
  const container = document.getElementById('chart4');
  const { innerH, innerW, x, y, g, xAxisG, yAxisG } = setupChart(container, { left: 60, bottom: 25 }, 'band', 'vertical');

  let sumWithDB = 0, countWithDB = 0;
  let sumNoDB = 0, countNoDB = 0;

  filteredData.forEach(d => {
    const hasLang = !!d.Language;
    const hasDB = d.Database && d.Database !== 'NA' && d.Database.trim() !== '';
    if (hasLang && hasDB) { sumWithDB += +d.Salary; countWithDB++; } 
    else if (hasLang && !hasDB) { sumNoDB += +d.Salary; countNoDB++; }
  });

  const data = [
    { type: 'Language Only', avg: countNoDB ? sumNoDB / countNoDB : 0, count: countNoDB },
    { type: 'Lang + Database', avg: countWithDB ? sumWithDB / countWithDB : 0, count: countWithDB }
  ];

  // PADDING FIX for Bar Charts: Start from 0 but add top buffer
  x.domain(data.map(d => d.type));
  y.domain([0, d3.max(data, d => d.avg) * 1.15 || 100000]); // 15% top buffer

  yAxisG.transition().duration(DURATION).call(d3.axisLeft(y).ticks(5).tickFormat(d => `$${d/1000}k`));
  xAxisG.transition().duration(DURATION).call(d3.axisBottom(x));

  g.selectAll(".bar").data(data, d => d.type).join(
      enter => enter.append("rect").attr("class", "bar")
        .attr("x", d => x(d.type) + x.bandwidth()*0.2) 
        .attr("width", x.bandwidth() * 0.6)
        .attr("y", innerH).attr("height", 0)
        .attr("fill", d => d.type.includes('Database') ? '#8b5cf6' : '#94a3b8')
        .call(enter => enter.transition().duration(DURATION)
          .attr("y", d => y(d.avg))
          .attr("height", d => innerH - y(d.avg))),
      update => update.call(update => update.transition().duration(DURATION)
        .attr("y", d => y(d.avg))
        .attr("height", d => innerH - y(d.avg))),
      exit => exit.call(exit => exit.transition().duration(DURATION).attr("height", 0).attr("y", innerH).remove())
    )
    .on("mouseover", (e, d) => showTooltip(e, `<b>${d.type}</b><br>Avg: $${Math.round(d.avg).toLocaleString()}<br>N: ${d.count}`))
    .on("mouseout", hideTooltip);
}

// ==========================================
// CHART 5: Org Size
// ==========================================
function renderChart5() {
  const container = document.getElementById('chart5');
  const { innerH, innerW, x, y, g, xAxisG, yAxisG } = setupChart(container, { left: 100, bottom: 25 });

  const orgStats = new Map();
  filteredData.forEach(d => {
    const org = d.OrgSize || 'Unknown';
    if (!orgStats.has(org)) orgStats.set(org, { sum: 0, count: 0 });
    const entry = orgStats.get(org);
    entry.sum += +d.Salary;
    entry.count += 1;
  });

  const data = [];
  ORG_ORDER.forEach(org => {
    if (orgStats.has(org)) {
      const val = orgStats.get(org);
      if (val.count > 0) {
        let label = org;
        if (org.includes("Just me")) label = "Freelancer";
        else if (org.includes("10,000")) label = "10,000+";
        else if (org.includes("Unknown")) label = "Unknown";
        else label = label.replace(" employees", "");
        data.push({ org: org, label: label, avg: val.sum / val.count, count: val.count });
      }
    }
  });

  y.domain(data.map(d => d.label));
  x.domain([0, d3.max(data, d => d.avg) * 1.1 || 100000]);

  yAxisG.transition().duration(DURATION).call(d3.axisLeft(y));
  xAxisG.transition().duration(DURATION).call(d3.axisBottom(x).ticks(4).tickFormat(d => `$${d/1000}k`));

  g.selectAll(".bar").data(data, d => d.label).join(
      enter => enter.append("rect").attr("class", "bar")
        .attr("y", d => y(d.label))
        .attr("height", y.bandwidth())
        .attr("x", 0).attr("width", 0).attr("fill", "#f59e0b")
        .call(enter => enter.transition().duration(DURATION).attr("width", d => x(d.avg))),
      update => update.call(update => update.transition().duration(DURATION)
        .attr("y", d => y(d.label)).attr("height", y.bandwidth())
        .attr("width", d => x(d.avg))),
      exit => exit.call(exit => exit.transition().duration(DURATION).attr("width", 0).remove())
    )
    .on("mouseover", (e, d) => showTooltip(e, `<b>${d.label}</b><br>Avg: $${Math.round(d.avg).toLocaleString()}`))
    .on("mouseout", hideTooltip);
}

// ==========================================
// CHART 6: AI Adoption (FIXED PADDING)
// ==========================================
function renderChart6() {
  const container = document.getElementById('chart6');
  const { innerH, innerW, x, y, g, xAxisG, yAxisG } = setupChart(container, { left: 60, bottom: 25 }, 'band', 'vertical');

  const aiStats = new Map();
  filteredData.forEach(d => {
    const ai = d.AI_Simple;
    if (ai === 'Unknown') return;
    if (!aiStats.has(ai)) aiStats.set(ai, { sum: 0, count: 0 });
    const entry = aiStats.get(ai);
    entry.sum += +d.Salary;
    entry.count += 1;
  });

  const data = Array.from(aiStats.entries())
    .map(([type, val]) => ({ type, avg: val.sum / val.count, count: val.count }));

  x.domain(['No', 'Yes']);
  y.domain([0, d3.max(data, d => d.avg) * 1.15 || 100000]);

  yAxisG.transition().duration(DURATION).call(d3.axisLeft(y).ticks(5).tickFormat(d => `$${d/1000}k`));
  xAxisG.transition().duration(DURATION).call(d3.axisBottom(x));

  g.selectAll(".bar").data(data, d => d.type).join(
      enter => enter.append("rect").attr("class", "bar")
        .attr("x", d => x(d.type) + x.bandwidth()*0.25)
        .attr("width", x.bandwidth()*0.5)
        .attr("y", innerH).attr("height", 0)
        .attr("fill", d => d.type === 'Yes' ? '#38bdf8' : '#64748b')
        .call(enter => enter.transition().duration(DURATION)
          .attr("y", d => y(d.avg))
          .attr("height", d => innerH - y(d.avg))),
      update => update.call(update => update.transition().duration(DURATION)
        .attr("y", d => y(d.avg))
        .attr("height", d => innerH - y(d.avg))),
      exit => exit.call(exit => exit.transition().duration(DURATION).attr("height", 0).attr("y", innerH).remove())
    )
    .on("mouseover", (e, d) => showTooltip(e, `<b>${d.type}</b><br>Avg: $${Math.round(d.avg).toLocaleString()}`))
    .on("mouseout", hideTooltip);
}


// ==========================================
// UTILS
// ==========================================
function setupChart(container, margin, type='band', orient='horizontal') {
  // We need to keep SVG if exists, but check dimensions
  const width = container.clientWidth || 400;
  const height = container.clientHeight || 300;
  const innerW = Math.max(0, width - margin.left - (margin.right || 20));
  const innerH = Math.max(0, height - (margin.top || 10) - margin.bottom);

  let svg = d3.select(container).select("svg");
  let g;

  if (svg.empty()) {
    svg = d3.select(container).append("svg");
    g = svg.append("g").attr("class", "chart-group");
    g.append("g").attr("class", "x-axis axis");
    g.append("g").attr("class", "y-axis axis");
  } else {
    g = svg.select(".chart-group");
  }

  // Always update dimensions in case of resize
  svg.attr("width", width).attr("height", height);
  g.attr("transform", `translate(${margin.left},${margin.top || 10})`);
  
  // Position Axes
  g.select(".x-axis").attr("transform", `translate(0,${innerH})`);

  let x, y;
  if (orient === 'horizontal') {
    y = d3.scaleBand().range([0, innerH]).padding(0.2);
    x = d3.scaleLinear().range([0, innerW]);
  } else {
    if (type === 'linear') {
      x = d3.scaleLinear().range([0, innerW]);
    } else {
      x = d3.scaleBand().range([0, innerW]).padding(0.3);
    }
    y = d3.scaleLinear().range([innerH, 0]);
  }

  return { svg, g, innerH, innerW, x, y, xAxisG: g.select(".x-axis"), yAxisG: g.select(".y-axis") };
}

const tooltipDiv = document.getElementById('tooltip');
function showTooltip(event, html) {
  tooltipDiv.innerHTML = html;
  tooltipDiv.style.opacity = 1;
  tooltipDiv.style.left = (event.pageX + 15) + 'px';
  tooltipDiv.style.top = (event.pageY - 28) + 'px';
}
function hideTooltip() {
  tooltipDiv.style.opacity = 0;
}

window.addEventListener('resize', debounce(() => {
  if (filteredData.length) updateDashboard();
}, 300));

function debounce(fn, ms) {
  let timer;
  return () => { clearTimeout(timer); timer = setTimeout(fn, ms); }
}
</script>
</body>
</html>